---
title: "Preprocess GSE76275, so that we can perform GFS on it separately"
output: 
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
---

# Loading libraries


```{r}
library(GEOquery)
library(oligo)
library(tidyverse)
```



# Prepare the metadata

## Getting data from GEOquery

```{r}
geodata <- GEOquery::getGEO(GEO = "GSE76275", destdir = "./tempfiles")
```


```{r}
mdata <- geodata %>%
  pluck(1) %>%
  phenoData() %>%
  pData() %>% as_tibble()
```



## Cleaning the metadata


```{r}
mdata <- mdata %>% 
  select(title, contains("date"), geo_accession, contains(":ch1"))

cnames <- colnames(mdata)

cnames_processed <- str_split(cnames, pattern = ":") %>% 
  map_chr(~{.x[[1]]}) %>% 
  str_replace_all(" ", "_") %>% 
  str_replace_all("-", "_") %>% 
  str_remove_all("\\(|\\)|,")

cnames_processed

colnames(mdata) <- cnames_processed
rm(cnames, cnames_processed)
  
```


```{r}
glimpse(mdata)
```


# Reading in raw probe intensity data

Celfiles downloaded from GEO and kept the folder "celfiles/"

```{r}
celFiles <- list.celfiles('celfiles/', full.names = TRUE, listGzipped = TRUE)
celFiles %>% head()
```



```{r}
names(celFiles) <- celFiles %>% 
  basename() %>% 
  str_split("\\.") %>% 
  map_chr(~{.x[1]}) %>% 
  str_split("_") %>% 
  map_chr(~{.x[1]}) 

head(celFiles)
```

Rearranging rows of metadata to fit the order of the celfiles.

```{r}
mdata <- mdata[match(mdata$geo_accession, names(celFiles)), ]
```


Getting only the relevant variables from the metadata.

```{r}
mdata_subset <- mdata %>%
  select(geo_accession, 
         title, 
         triple_negative_status, 
         tnbc_subtype,
         submission_date,
         er,
         her2,
         pr,
         race,
         set,
         gender, 
         age_years) %>% 
  mutate(across(where(is.character), .fns = factor)) %>% 
  mutate(tnbc_subtype = if_else(is.na(as.character(tnbc_subtype)), "Not Applicable", as.character(tnbc_subtype))) %>% 
  mutate(tnbc_subtype = factor(tnbc_subtype)) %>% 
  as.data.frame()


rownames(mdata_subset) <- as.character(mdata_subset$geo_accession)

head(mdata_subset)

```

```{r}
rawData <- read.celfiles(celFiles, phenoData = AnnotatedDataFrame(mdata_subset))
```



# Getting expression values from raw data


```{r}
rawData_summary <- rma(rawData, background = TRUE, normalize = FALSE)
```


```{r}
emat_df <- exprs(rawData_summary) %>% 
  as_tibble(rownames = "ID")

head(emat_df)
```

Write the expression matrix to be fed into GFS.

```{r}
emat_df %>% 
  write_csv("dataframe_files/GSE76275_withoutQN.csv")
```
